# Redis Stream Conventions

This document defines the conventions for Redis Streams used in the AI Support System.

## Streams

### 1. `ticket_events`
The primary stream for all ticket-related activities that require asynchronous processing (AI response, analytics, notifications).

- **Key**: `ticket_events`
- **Max Length**: 10,000 (Approximate using `XADD ~ 10000`)
- **Event ID**: Generated by Redis (Timestamp-Sequence).

#### Event Types
- `TICKET_CREATED`: Triggered when a new ticket is opened.
- `MESSAGE_RECEIVED`: Triggered when a user sends a message.
- `AI_RESPONSE_GENERATED`: Triggered by the worker when a response is ready.
- `TICKET_CLOSED`: Triggered when a ticket is closed.

#### Payload Structure
All events are serialized JSON strings under the `data` field.
```json
{
  "event_type": "MESSAGE_RECEIVED",
  "ticket_id": "uuid",
  "message_id": "uuid",
  "user_id": "uuid",
  "payload": {
    "content": "sanitized_string",
    "timestamp": "iso_date"
  }
}
```

## Consumer Groups

### 1. `ai_processor_group`
- **Purpose**: Consumes events to generate AI responses.
- **Consumer ID Architecture**: `worker:{hostname}:{pid}`

### 2. `analytics_group`
- **Purpose**: Consumes events for DuckDB ingestion.

## Idempotency Rules

- **Deduplication**: The AI Worker checks the `message_id` in a Redis Set `processed_messages:{ticket_id}` before acting.
- **TTL**: The deduplication keys expire after 24 hours.
- **ACK Policy**: 
    - Worker reads via `XREADGROUP`.
    - Worker processes and saves to Postgres.
    - Worker calls `XACK` only after Postgres commit confirms success.
    - `XPENDING` is audited by a background task for retries.

## Sample Commands

### Create Consumer Group
```bash
XGROUP CREATE ticket_events ai_processor_group $ MKSTREAM
```

### Add Event
```bash
XADD ticket_events * data '{"event_type": "MESSAGE_RECEIVED", "ticket_id": "...", "message_id": "..."}'
```

### Read New Messages
```bash
XREADGROUP GROUP ai_processor_group worker_1 COUNT 1 STREAMS ticket_events >
```
