# metrics.py
"""Collect and aggregate metrics from experiment runs.

Functions:
- `load_results(csv_path)`: Load CSV generated by `crack_simulation.py`.
- `summarize(results)`: Compute overall success rates per algorithm.
- `export_summary(summary, out_path)`: Write a JSON summary.
"""

import csv
import json
from pathlib import Path
from typing import List, Dict

def load_results(csv_path: Path) -> List[Dict[str, str]]:
    with open(csv_path, "r", encoding="utf-8") as f:
        reader = csv.DictReader(f)
        return [row for row in reader]

def summarize(results: List[Dict[str, str]]) -> Dict[str, Dict[str, float]]:
    summary: Dict[str, Dict[str, float]] = {}
    for row in results:
        algo = row["algorithm"]
        total = int(row["total_hashes"])
        cracked = int(row["cracked_hashes"])
        if algo not in summary:
            summary[algo] = {"total": 0, "cracked": 0}
        summary[algo]["total"] += total
        summary[algo]["cracked"] += cracked
    # compute rates
    for algo, data in summary.items():
        total = data["total"]
        cracked = data["cracked"]
        data["success_rate_percent"] = (cracked / total) * 100 if total else 0.0
    return summary

def export_summary(summary: Dict[str, Dict[str, float]], out_path: Path):
    # Remove raw totals if not needed for final report
    clean = {algo: {"success_rate_percent": data["success_rate_percent"]} for algo, data in summary.items()}
    with open(out_path, "w", encoding="utf-8") as f:
        json.dump(clean, f, indent=2)
    print(f"Summary exported to {out_path}")

if __name__ == "__main__":
    csv_file = Path(__file__).parent / "crack_results.csv"
    out_json = Path(__file__).parent / "summary.json"
    results = load_results(csv_file)
    summary = summarize(results)
    export_summary(summary, out_json)
